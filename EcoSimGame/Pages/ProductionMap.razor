@page "/productionmap"
@using EcoSimGame.Models
@using EcoSimGame.Models.List
@using EcoSimGame.Components

@inject Services.GameStateService game

<div class="production-map">
    <div class="top-row">
        @for (int i = 0; i < game.PowerPlantSlots.Count; i++)
        {
            var index = i;
            var slot = game.PowerPlantSlots[index];

            <div class="slot power-plant" @onclick="@(() => OnPowerPlantSlotClicked(index))">
                @if (slot.IsOccupied && slot.Building is not null)
                {
                    var imageName = GetImageName(slot.Building.Name);

                    <div class="power-plant-slot-content">
                        <img src=@($"images/energy/{imageName}.png") alt="@slot.Building.Name" class="power-plant-icon" />
                        <div class="production-info">+@slot.Building.EnergyPerTick energii</div>
                    </div>
                }
                else
                {
                    <span>Zbuduj elektrownie</span>
                }
            </div>
        }
    </div>

    <div class="energy-storage-row">
        @for (int i = 0; i < game.EnergyStorageSlots.Count; i++)
        {
            var index = i;
            var slot = game.EnergyStorageSlots[index];

            <div class="slot energy-storage" @onclick="() => OnEnergyStorageSlotClicked(index)">
                @if (slot.IsBuilt)
                {
                    <div>
                        <strong>Magazyn energii</strong><br />
                        Pojemność: @slot.Capacity<br />
                        Poziom: @slot.Level
                    </div>
                }
                else
                {
                    <span>Zbuduj magazyn energii</span>
                }
            </div>
        }
    </div>

    <!-- Middle rows -->
    <div class="middle-row">
        <div class="slot warehouse"><span>magazyn</span></div>
        <div class="factory-grid">
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
        </div>
        <div class="slot warehouse"><span>magazyn</span></div>
    </div>

    <div class="middle-row">
        <div class="slot warehouse"><span>magazyn</span></div>
        <div class="factory-grid">
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
            <div class="slot factory"><span>fabryka</span></div>
        </div>
        <div class="slot warehouse"><span>magazyn</span></div>
    </div>
</div>

<EnergyPurchaseModal IsOpen="@isChoosing"
                     EnergyBuildings="@EnergyProductionList.AllBuildings"
                     OnSelectBuilding="ConfirmBuild"
                     Close="CloseModal" />
<EnergyStorageModal IsOpen="@isEnergyStorageModalOpen"
                    Slot="@game.EnergyStorageSlots[selectedEnergyStorageIndex]"
                    Close="CloseModal"
                    OnUpgrade="UpgradeEnergyStorage" />


@code {
    private bool isChoosing = false;
    private int selectedSlotIndex;

    private bool isEnergyStorageModalOpen = false;
    private int selectedEnergyStorageIndex;

    private string? errorMessage;

    protected override void OnInitialized()
    {
        game.InitializePowerSlots();
        game.OnUpdate += StateHasChanged;
    }

    private void OnPowerPlantSlotClicked(int index)
    {
        selectedSlotIndex = index;
        isChoosing = true;
        StateHasChanged();
    }

    private void OnEnergyStorageSlotClicked(int index)
    {
        selectedEnergyStorageIndex = index;
        isEnergyStorageModalOpen = true;
    }

    private Task CloseEnergyStorageModal()
    {
        isEnergyStorageModalOpen = false;
        return Task.CompletedTask;
    }

    private async Task UpgradeEnergyStorage()
    {
        isEnergyStorageModalOpen = false;
        await game.Save();
        StateHasChanged();
    }

    private async Task RefreshPage()
    {
        isEnergyStorageModalOpen = false;
        await game.Save();
    }

    private async Task ConfirmBuild(EnergyProduction building)
    {
        var i = selectedSlotIndex;

        if (i < 0 || i >= game.PowerPlantSlots.Count)
        {
            errorMessage = "Nieprawidłowy slot!";
            return;
        }

        if (game.Player.Money >= building.Cost)
        {
            game.Player.Money -= building.Cost;

            game.SetPowerPlant(i, building);

            await game.Save();
            isChoosing = false;
        }
        else
        {
            errorMessage = "Za mało pieniędzy!";
        }
    }

    private string GetImageName(string name)
    {
        return name.ToLower()
            .Replace(" ", "")
            .Replace("ż", "z").Replace("ó", "o").Replace("ł", "l")
            .Replace("ć", "c").Replace("ś", "s").Replace("ą", "a")
            .Replace("ę", "e").Replace("ź", "z").Replace("ń", "n");
    }

    private void CloseModal()
    {
        isChoosing = false;
        isEnergyStorageModalOpen = false;
    }

    public void Dispose()
    {
        game.OnUpdate -= StateHasChanged;
    }
}
@page "/Shop"
@using Blazored.LocalStorage
@using EcoSimGame.Models
@using EcoSimGame.Models.List
@using EcoSimGame.Services
@inject ILocalStorageService localStorage
@inject MarketService market

<h3>Sklep</h3>

<p><em>Ceny zmienią się za: @secondsLeft s</em></p>

@if (buyableMaterials != null && sellableMaterialsProcessed != null && sellableMaterialsProducts != null)
{
    <div class="shop-container">
        <div class="shop-left">
            <h4>Zakupy</h4>
            @foreach (var material in buyableMaterials)
            {
                var price = market.GetPrice(material.Name);
                <p><strong>@material.Name</strong> – Cena: @price</p>
                <button @onclick="() => Buy(material.Name)" disabled="@(player.Money < price)">Kup</button>
            }
        </div>

        <div class="shop-right">
            <h4>Sprzedaż</h4>

            <h5>Materiały przetworzone</h5>
            @foreach (var material in sellableMaterialsProcessed)
            {
                var quantity = player.Inventory.GetQuantity(material.Name);
                var price = market.GetPrice(material.Name);
                <p><strong>@material.Name</strong> – Cena: @price (Masz: @quantity)</p>
                <button @onclick="() => Sell(material.Name)" disabled="@(quantity == 0)">Sprzedaj</button>
            }

            <h5>Produkty</h5>
            @foreach (var material in sellableMaterialsProducts)
            {
                var quantity = player.Inventory.GetQuantity(material.Name);
                var price = market.GetPrice(material.Name);
                <p><strong>@material.Name</strong> – Cena: @price (Masz: @quantity)</p>
                <button @onclick="() => Sell(material.Name)" disabled="@(quantity == 0)">Sprzedaj</button>
            }
        </div>
    </div>
}
else
{
    <p>Ładowanie danych sklepu...</p>
}

@code {
    private Player player = new();
    private List<Material> buyableMaterials = new();
    private List<Material> sellableMaterialsProcessed = new();
    private List<Material> sellableMaterialsProducts = new();
    private System.Timers.Timer refreshTimer;
    private int secondsLeft = 30;

    protected override async Task OnInitializedAsync()
    {
        var storedPlayer = await localStorage.GetItemAsync<Player>("player");
        if (storedPlayer != null)
        {
            player = storedPlayer;
        }

        buyableMaterials = MaterialList.AllMaterials
            .Where(m => new[] { "Drewno", "Ruda żelaza", "Glina", "Len" }.Contains(m.Name))
            .ToList();

        sellableMaterialsProcessed = MaterialList.AllMaterials
            .Where(m => new[] { "Deski", "Sztabka żelaza", "Cegła", "Płótno" }.Contains(m.Name))
            .ToList();

        sellableMaterialsProducts = MaterialList.AllMaterials
            .Where(m => new[] { "Narzędzia", "Odzież" }.Contains(m.Name))
            .ToList();

        refreshTimer = new System.Timers.Timer(100);
        refreshTimer.Elapsed += (_, _) => InvokeAsync(UpdateCountdown);
        refreshTimer.Start();
    }

    private void UpdateCountdown()
    {
        var elapsed = (DateTime.Now - market.LastPriceUpdate).TotalSeconds;
        secondsLeft = 30 - (int)(elapsed % 30);
        StateHasChanged();
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }

    private async Task Buy(string materialName)
    {
        var price = market.GetPrice(materialName);
        if (player.Money >= price)
        {
            player.Money -= price;
            player.Inventory.Add(materialName, 1);
            market.AffectPrice(materialName, 1);
            await localStorage.SetItemAsync("player", player);
        }
    }

    private async Task Sell(string materialName)
    {
        var price = market.GetPrice(materialName);
        if (player.Inventory.Remove(materialName, 1))
        {
            player.Money += price;
            market.AffectPrice(materialName, -1);
            await localStorage.SetItemAsync("player", player);
        }
    }
}
